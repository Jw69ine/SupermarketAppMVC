    <!DOCTYPE html>
    <html>
    <head>
    <meta charset="UTF-8">
    <title>Admin - Refund Requests</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
    <%- include('partials/navbar', { user: user }) %>
    </head>

    <body class="bg-light">
    <div class="container my-5">
        <h2 class="mb-3">Refund Requests</h2>

        <% if (errors && errors.length) { %>
        <div class="alert alert-danger"><%= errors[0] %></div>
        <% } %>
        <% if (messages && messages.length) { %>
        <div class="alert alert-success"><%= messages[0] %></div>
        <% } %>

        <div class="card p-3">
        <% if (refunds && refunds.length) { %>
            <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Order</th>
                    <th>User</th>
                    <th>Amount</th>
                    <th>Provider</th>
                    <th>Provider Payment ID</th>
                    <th>Reason</th>
                    <th>Status</th>
                    <th style="width: 260px;">Actions</th>
                </tr>
                </thead>

                <tbody>
                <% refunds.forEach(r => { %>
                    <tr>
                    <td><%= r.id %></td>

                    <td>
                        #<%= r.order_id %>
                        <div class="small text-muted"><%= r.orderDate %></div>
                    </td>

                    <td>
                        <%= r.username %>
                        <div class="small text-muted"><%= r.email %></div>
                    </td>

                    <td>
                        $<%= Number((r.amount != null ? r.amount : (r.order_total != null ? r.order_total : 0))).toFixed(2) %>
                        <span class="text-muted"><%= r.currency || '' %></span>
                    </td>

                    <td><%= r.provider || 'N/A' %></td>

                    <td class="small text-muted"><%= r.provider_payment_id || 'N/A' %></td>

                    <td><%= r.reason %></td>

                    <td>
                        <span class="badge bg-secondary"><%= r.status %></span>
                    </td>
                    <td>
                    <% if (r.status === 'pending') { %>
                        <form method="POST" action="/admin/refunds/<%= r.id %>/approve" class="d-inline">
                        <button class="btn btn-sm btn-success">Approve & Refund</button>
                        </form>

                        <form method="POST" action="/admin/refunds/<%= r.id %>/reject" class="d-inline">
                        <input name="admin_note" class="form-control form-control-sm d-inline-block" style="width:140px" placeholder="Reason" />
                        <button class="btn btn-sm btn-danger">Reject</button>
                        </form>

                        <% if (!r.provider || !r.provider_payment_id || !r.amount) { %>
                        <div class="small text-warning mt-1">
                            Missing payment info (provider/provider_payment_id/amount). Refund cannot be processed until payment row exists.
                        </div>
                        <% } %>
                    <% } else { %>
                        <span class="text-muted small">No actions</span>
                    <% } %>
                    </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
            </div>
        <% } else { %>
            <div class="text-muted">No refund requests.</div>
        <% } %>
        </div>
    </div>
    </body>
    </html>
